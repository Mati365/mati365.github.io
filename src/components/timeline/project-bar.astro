---
import type { ExperienceItem } from './types';

interface Props {
  year: number;
  experience: ExperienceItem;
}

const { experience, year } = Astro.props;
const { company, duration } = experience;

const getMonthsInYear = (year: number, start: Date, end: Date) => {
  const yearStart = new Date(year, 0, 1);
  const yearEnd = new Date(year, 11, 31);

  const effectiveStart = start < yearStart ? yearStart : start;
  const effectiveEnd = end > yearEnd ? yearEnd : end;

  return {
    start: effectiveStart.getMonth(),
    end: effectiveEnd.getMonth(),
    total: effectiveEnd.getMonth() - effectiveStart.getMonth() + 1
  };
};

const { start, total } = getMonthsInYear(year, duration.begin, duration.end || new Date);
const widthPercentage = (total / 12) * 100;
const startPercentage = (start / 12) * 100;

const { color } = company;
const showCompanyName = total > 2;
const showTitle = total > 4;
---

<div
  class="top-0 hover:brightness-110 hover:z-10 absolute rounded-lg h-12 transition-all cursor-pointer hover:scale-[1.02] project-bar"
  data-details={company.name}
  style={`
    left: ${startPercentage}%;
    width: ${widthPercentage}%;
    background-color: ${color.background || color.primary};
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.03) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.03) 50%, rgba(255, 255, 255, 0.03) 75%, transparent 75%, transparent);
    background-size: 10px 10px;
  `}
>
  <div class="absolute inset-0 flex justify-center items-center gap-2 px-2">
    <div class="flex-shrink-0">
      <div class="bg-white/90 shadow-md px-2 py-1.5 rounded-lg">
        <img
          src={company.logo}
          alt={`${company.name} logo`}
          class="max-w-full h-5 object-contain"
          class:list={[
            !showTitle && 'h-auto w-9'
          ]}
          loading="lazy"
        />
      </div>
    </div>
    {showCompanyName && showTitle && (
      <div
        class="flex flex-col flex-1 min-w-0"
        style={{
          color: color.text || '#ffffff',
        }}
      >
        {showCompanyName && (
          <span
            class="font-medium text-sm truncate"
            title={company.name}
          >
            {company.name}
          </span>
        )}
        {showTitle && (
          <span
            class="opacity-90 font-medium text-xs truncate"
            title={experience.title}
          >
            {experience.title}
          </span>
        )}
      </div>
    )}
  </div>
</div>
